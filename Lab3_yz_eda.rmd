---
title: "Lab3_YZ_EDA"
author: "Yulia Zamriy"
date: "March 18, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(knitr.table.format = "latex")
```

```{r}
#install.packages("kableExtra")
#install.packages("viridisLite")
#install.packages("viridis")
#install.packages("Hmisc")
library(knitr)
library(kableExtra)
library(Hmisc)
library(reshape2)
library(ggplot2)
```

```{r}
#setwd("/home/yulia/Documents/MIDS/W203/Lab_3/")
crime <- read.csv("crime_v2.csv", stringsAsFactors = FALSE)
crime <- na.omit(crime)
```

```{r}
summary(crime$crmrte)
```

```{r}
hist(crime$crmrte)
```

```{r}
crime$prbconv <- as.numeric(crime$prbconv)
```


```{r}
summary(crime$prbarr)
summary(crime$prbconv)
summary(crime$prbpris)
```

```{r}
nrow(crime[crime$prbarr >= 1,])
```
```{r}
nrow(crime[crime$prbconv >= 1,])
```

```{r}
crime$exclude <- 0
crime[crime$prbarr > 1,]$exclude <- 1
crime[crime$prbconv > 1,]$exclude <- 1
table(crime$exclude)
```

```{r}
summary(crime$avgsen)
```
```{r}
summary(crime$polpc)
```

```{r}
summary(crime$density)
```

```{r}
summary(crime$taxpc)
```

```{r}
mean(crime$west)
mean(crime$central)
mean(crime$urban)
```

```{r}
summary(crime$pctmin80)
```

```{r}
summary(crime$wcon)
```

```{r}
summary(crime$wtuc)
```

```{r}
summary(crime$wtrd)
```

```{r}
summary(crime$wfir)
```

```{r}
summary(crime$wser)
```

```{r}
summary(crime$wmfg)
```

```{r}
summary(crime$wfed)
```

```{r}
summary(crime$wsta)
```

```{r}
summary(crime$wloc)
```

```{r}
summary(crime$mix)
```

```{r}
summary(crime$pctymle)
```

```{r}
crime[crime$wser > 2000,]$exclude <- 1
crime_sub <- subset(crime, exclude == 0)
crime_sub$exclude <- NULL
```


```{r}
# Prepare a .RData for easier sharing and usage.
ind_variables <- c(
  'prbarr', 'prbconv', 'prbpris', 'avgsen', 
  'polpc', 'density', 'taxpc', 'west', 'central', 'urban', 'pctmin80', 'wcon', 
  'wtuc', 'wtrd', 'wfir', 'wser', 'wmfg', 'wfed', 'wsta', 'wloc', 'mix', 
  'pctymle'
)
var_labels <- c(
  'probability of arrest', 'probability of conviction', 
  'probability of prison sentence', 'avg. sentence, days', 
  'police per capita', 'people per sq. mile', 'tax revenue per capita', 
  '=1 if in western N.C.', '=1 if in central N.C.', '=1 if in SMSA', 
  'perc. minority, 1980', 'weekly wage, construction', 
  'wkly wge, trns, util, commun', 'wkly wge, whlesle, retail trade', 
  'wkly wge, fin, ins, real est', 'wkly wge, service industry', 
  'wkly wge, manufacturing', 'wkly wge, fed employees', 
  'wkly wge, state employees', 'wkly wge, local gov emps', 
  'offense mix: face-to-face/other', 'percent young male'
)
impact <- c("Negative" , "Negative", "Negative", "Negative",
            "Negative", "Positive", "Negative", 
            "Unclear", "Unclear", "Unclear", "Unclear",
            "Negative","Negative","Negative",
            "Negative", "Negative", "Negative", "Negative",
            "Negative", "Negative", "Unclear","Positive")
control <- c("Yes", "Yes", "Yes", "Yes",
             "Yes", "No", "Yes", 
             "No", "No", "No","No",
             "Yes", "Yes", "Yes",
             "Yes", "Yes", "Yes", "Yes", 
             "Yes", "Yes", "No", "No")
desc <- data.frame(ind_variables, var_labels, impact, control)
colnames(desc) <- c("Explanatory Variables", 
                    "Explanation", 
                    "Expected Impact on Crime Rate",
                    "Can Gov Impact on This?")
# col_labels <-  c(ind_variables = "Explanatory Variables", 
#                  var_labels = "Explanation")
# desc <- upData(desc, labels = col_labels)
```

```{r}
kable(desc, booktabs = TRUE) %>%
  kable_styling(latex_options = c("scale_down"),
                full_width = FALSE) %>% 
  row_spec(0, bold = TRUE) %>% 
  column_spec(1, width = "8em") %>% 
  column_spec(3, width = "10em") %>% 
  column_spec(4, width = "9em")
```

```{r}
crime_cor <- cor(crime_sub)[3,-c(1,2,3)]
crime_cor <- crime_cor[order(crime_cor)]
negative <- ifelse(crime_cor < 0, 1,0)
```

```{r}

crime_cor_lab <- ifelse(crime_cor < 0, crime_cor-0.15, crime_cor)

par(mar = c(2,8,1,0))
b <- barplot(crime_cor,
        col = negative,
        horiz = TRUE,
        las = 1,
        xaxt = "n",
        xlim = c(-1,1),
        main = "Correlation of Crime Rate with Other Variables")
text(x = crime_cor_lab, 
     y = b, 
     label = round(crime_cor,2), 
     pos = 4, 
     cex = 0.6)
axis(1, 
     at = seq(-1,1, by = 0.2), 
     labels = seq(-1,1, by = 0.2),
     cex.axis = 0.6)
```

```{r}
cor_mat <- round(cor(crime_sub[-c(1:3)]),2)
get_upper_tri <- function(cor_mat){
    cor_mat[lower.tri(cor_mat)]<- NA
    return(cor_mat)
}
cor_mat_upper <- get_upper_tri(cor_mat)
cor_mat_upper2 <- melt(cor_mat_upper, na.rm = TRUE)
cor_mat_upper2[cor_mat_upper2$value == 1,]$value <- 0
```

```{r}
ggplot(data = cor_mat_upper2, aes(Var1, Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white",
                        midpoint = 0, limit = c(-1,1), space = "Lab",
                        name = "Correlation") +
  theme_minimal() +
  scale_x_discrete(position = "top") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 8, hjust = 0),
        axis.title.x=element_blank(),
        axis.title.y=element_blank()) +
  coord_fixed()
```

```{r}
ind_vars_all <- c("prbarr", "prbconv", "prbpris", "avgsen", "polpc", "density", "taxpc",
               "west", "central", "urban", "pctmin80", "wcon", "wtuc", "wtrd", "wfir",
               "wser", "wmfg", "wfed", "wsta", "wloc", "mix", "pctymle")
ind_vars1 <- c("polpc", "taxpc","wfed","pctymle","avgsen")
```

```{r}
crmrte_formula1 <- as.formula(paste("crmrte ~", paste(ind_vars1, collapse = "+"), sep = ""))
crmrte_lm1 <- lm(crmrte_formula1, data = crime_sub)
summary(crmrte_lm1)
```

```{r}
crmrte_formula_all <- as.formula(paste("crmrte ~", paste(ind_vars_all, collapse = "+"), sep = ""))
crmrte_lm0 <- lm(crmrte ~ 1,
                 data = crime_sub)
crmrte_lm_all <- lm(crmrte_formula_all,
                 data = crime_sub)
crmrte_lm_step <- step(crmrte_lm0, scope=list(lower=crmrte_lm0, upper=crmrte_lm_all), 
                       direction="both",
                       trace = FALSE)
summary(crmrte_lm_step)
```

